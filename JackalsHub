-- Delta Executor: Auto Player Monitor to Discord
-- Paste langsung di executor dan execute

if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- CONFIGURASI
local DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1452686367141400720/oljlzYOmSXeYqzVcNNp0UnaqRLy4idbLZ-VRRYxr1UqRet5i_qWSaoh92L5JXnWlIxI7"
local SERVER_NAME = "Delta Monitor"
local LOG_ALL = true -- Log semua player join/leave

-- Check jika sudah running
if _G.DeltaMonitor then
    print("[Delta] Monitor sudah berjalan!")
    return
end

_G.DeltaMonitor = true

-- Fungsi bypass filter
local function safePost(url, data)
    local success, result = pcall(function()
        return request({
            Url = url,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(data)
        })
    end)
    return success, result
end

-- Send to Discord
local function sendEmbed(title, description, color, fields)
    local embed = {
        title = title,
        description = description,
        color = color,
        fields = fields or {},
        timestamp = DateTime.now():ToIsoDate(),
        footer = {
            text = "Delta Executor ‚Ä¢ " .. SERVER_NAME
        }
    }
    
    local data = {
        embeds = {embed},
        username = "üïµÔ∏è Delta Monitor",
        avatar_url = "https://cdn.discordapp.com/attachments/1216150554312089650/1216150554312089650/logo_roblox.jpg"
    }
    
    local success, response = safePost(DISCORD_WEBHOOK, data)
    if not success then
        warn("[Delta] Gagal kirim ke Discord:", response)
    end
    return success
end

-- Get player info detail
local function getPlayerInfo(player)
    local success, data = pcall(function()
        return game:GetService("HttpService"):JSONDecode(
            game:HttpGet("https://users.roblox.com/v1/users/" .. player.UserId)
        )
    end)
    
    if success and data then
        return {
            displayName = data.displayName or player.Name,
            created = os.date("%Y-%m-%d", data.created/1000) or "Unknown",
            banned = data.isBanned or false
        }
    end
    return nil
end

-- Player Join Monitor
local function onPlayerAdded(player)
    if not LOG_ALL then return end
    
    -- Tunggu sampai karakter load
    player.CharacterAdded:Wait()
    task.wait(1)
    
    local info = getPlayerInfo(player)
    local playerData = string.format(
        "üë§ **%s**\nüÜî `%s`\nüìÖ Akun: %s hari\n%s",
        player.Name,
        player.UserId,
        math.floor(player.AccountAge / 365),
        info and "üìõ Display: " .. info.displayName or ""
    )
    
    sendEmbed(
        "üéÆ PLAYER JOINED",
        playerData,
        0x00FF00, -- Hijau
        {
            {name = "üåê Server Info", value = string.format("Players: %d/%d\nJobID: `%s`", #Players:GetPlayers(), game.Players.MaxPlayers, game.JobId), inline = true},
            {name = "üïê Time", value = os.date("%H:%M:%S") .. "\n" .. os.date("%d/%m/%Y"), inline = true}
        }
    )
    
    print(string.format("[Delta] %s joined (Total: %d)", player.Name, #Players:GetPlayers()))
end

-- Player Leave Monitor
local function onPlayerRemoving(player)
    if not LOG_ALL then return end
    
    local playTime = "Unknown"
    if _G.PlayerJoinTimes and _G.PlayerJoinTimes[player.UserId] then
        local seconds = os.time() - _G.PlayerJoinTimes[player.UserId]
        local hours = math.floor(seconds / 3600)
        local minutes = math.floor((seconds % 3600) / 60)
        playTime = string.format("%02d:%02d:%02d", hours, minutes, seconds % 60)
    end
    
    sendEmbed(
        "üö™ PLAYER LEFT",
        string.format("**%s** left the server\nPlay Time: %s", player.Name, playTime),
        0xFF0000, -- Merah
        {
            {name = "üìä Remaining", value = string.format("%d/%d players", #Players:GetPlayers()-1, game.Players.MaxPlayers), inline = true},
            {name = "üÜî UserID", value = "`" .. tostring(player.UserId) .. "`", inline = true}
        }
    )
    
    print(string.format("[Delta] %s left (Remaining: %d)", player.Name, #Players:GetPlayers()-1))
end

-- Track join times
if not _G.PlayerJoinTimes then _G.PlayerJoinTimes = {} end

-- Initialize untuk player yang sudah ada
for _, player in ipairs(Players:GetPlayers()) do
    _G.PlayerJoinTimes[player.UserId] = os.time()
end

-- Connect events
Players.PlayerAdded:Connect(function(player)
    _G.PlayerJoinTimes[player.UserId] = os.time()
    onPlayerAdded(player)
end)

Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Periodic Server Status
local function sendPeriodicUpdate()
    while task.wait(900) do -- Setiap 15 menit
        local players = Players:GetPlayers()
        local playerNames = {}
        
        for _, p in ipairs(players) do
            table.insert(playerNames, p.Name)
        end
        
        sendEmbed(
            "üìä SERVER STATUS",
            string.format("**%s**\nUpdate otomatis setiap 15 menit", game.Name),
            0x0099FF, -- Biru
            {
                {name = "üë• Players Online", value = string.format("%d/%d", #players, game.Players.MaxPlayers), inline = true},
                {name = "üïê Uptime", value = "<t:" .. tostring(math.floor(workspace:GetServerTimeNow())) .. ":R>", inline = true},
                {name = "üéÆ Game", value = string.format("[%s](https://www.roblox.com/games/%d)", game.Name, game.PlaceId), inline = false},
                {name = "üìã Player List", value = #playerNames > 0 and table.concat(playerNames, "\n") or "No players", inline = false}
            }
        )
    end
end

-- Start periodic updates
task.spawn(sendPeriodicUpdate)

print("[Delta] Player Monitor aktif!")
print("[Delta] Total players awal:", #Players:GetPlayers())
print("[Delta] Discord Webhook:", DISCORD_WEBHOOK:sub(1, 30) .. "...")

-- GUI untuk kontrol (Delta Executor)
if not _G.DeltaMonitorGUI then
    local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()
    local Window = OrionLib:MakeWindow({
        Name = "Delta Player Monitor",
        HidePremium = false,
        SaveConfig = true,
        ConfigFolder = "DeltaMonitor"
    })
    
    local Tab = Window:MakeTab({
        Name = "Monitor",
        Icon = "rbxassetid://4483345998",
        PremiumOnly = false
    })
    
    Tab:AddToggle({
        Name = "Enable Monitor",
        Default = true,
        Callback = function(value)
            LOG_ALL = value
            OrionLib:MakeNotification({
                Name = "Delta Monitor",
                Content = value and "Monitor aktif!" or "Monitor nonaktif",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    })
    
    Tab:AddButton({
        Name = "Test Discord Webhook",
        Callback = function()
            sendEmbed("üß™ TEST NOTIFICATION", "Ini adalah test dari Delta Executor!\nWaktu: " .. os.date("%H:%M:%S"), 0xFFA500)
            OrionLib:MakeNotification({
                Name = "Test Sent!",
                Content = "Check Discord channel",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
        end
    })
    
    Tab:AddButton({
        Name = "Get Server Info",
        Callback = function()
            local info = string.format(
                "PlaceID: %d\nJobID: %s\nPlayers: %d/%d\nCreator: %d",
                game.PlaceId,
                game.JobId,
                #Players:GetPlayers(),
                game.Players.MaxPlayers,
                game.CreatorId
            )
            
            OrionLib:MakeNotification({
                Name = "Server Info",
                Content = info,
                Image = "rbxassetid://4483345998",
                Time = 10
            })
            
            setclipboard(info)
        end
    })
    
    Tab:AddTextbox({
        Name = "Set Discord Webhook",
        Default = DISCORD_WEBHOOK,
        TextDisappear = false,
        Callback = function(value)
            DISCORD_WEBHOOK = value
            OrionLib:MakeNotification({
                Name = "Webhook Updated",
                Content = "New webhook set!",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    })
    
    OrionLib:Init()
    _G.DeltaMonitorGUI = true
endPlayers.PlayerAdded:Connect(function(player)
    if not LOG_JOIN_LEAVE then return end
    
    local embed = {
        title = "üë§ Player Joined",
        description = string.format("**%s** has joined the server", player.Name),
        color = 3066993,  -- Hijau
        fields = {
            {
                name = "Player Info",
                value = string.format("Username: %s\nUserID: %s\nAccount Age: %d days", 
                    player.Name, 
                    tostring(player.UserId),
                    math.floor(player.AccountAge / 365)
                ),
                inline = true
            },
            {
                name = "Server Info",
                value = string.format("Total Players: %d/%d\nServer Time: %s",
                    #Players:GetPlayers(),
                    game.Players.MaxPlayers,
                    os.date("%H:%M:%S")
                ),
                inline = true
            }
        },
        footer = {
            text = "Roblox Server Monitor"
        },
        timestamp = DateTime.now():ToIsoDate()
    }
    
    sendToDiscord(embed)
    
    -- Simpan waktu join
    local joinTime = os.time()
    local storage = Instance.new("Folder")
    storage.Name = player.UserId
    storage:SetAttribute("JoinTime", joinTime)
    storage.Parent = ServerStorage
end)

-- Log player leave
Players.PlayerRemoving:Connect(function(player)
    if not LOG_JOIN_LEAVE then return end
    
    -- Hitung playtime
    local storage = ServerStorage:FindFirstChild(tostring(player.UserId))
    local playTime = 0
    if storage then
        local joinTime = storage:GetAttribute("JoinTime")
        if joinTime then
            playTime = os.time() - joinTime
        end
        storage:Destroy()
    end
    
    local hours = math.floor(playTime / 3600)
    local minutes = math.floor((playTime % 3600) / 60)
    local seconds = playTime % 60
    
    local embed = {
        title = "üö™ Player Left",
        description = string.format("**%s** has left the server", player.Name),
        color = 15158332,  -- Merah
        fields = {
            {
                name = "Play Time",
                value = string.format("%02d:%02d:%02d", hours, minutes, seconds),
                inline = true
            },
            {
                name = "Server Status",
                value = string.format("Remaining Players: %d/%d",
                    #Players:GetPlayers() - 1,  -- Karena belum di-remove
                    game.Players.MaxPlayers
                ),
                inline = true
            }
        },
        footer = {
            text = "Roblox Server Monitor"
        },
        timestamp = DateTime.now():ToIsoDate()
    }
    
    sendToDiscord(embed)
end)

-- Periodic server status update
local function sendServerStatus()
    local players = Players:GetPlayers()
    local playerList = {}
    
    for _, player in ipairs(players) do
        table.insert(playerList, player.Name)
    end
    
    local embed = {
        title = "üìä Server Status Report",
        description = string.format("**%s**", SERVER_NAME),
        color = 3447003,  -- Biru
        fields = {
            {
                name = "üìà Statistics",
                value = string.format("Players: **%d/%d**\nServer Uptime: <t:%d:R>\nGame: [%s](https://www.roblox.com/games/%d)",
                    #players,
                    game.Players.MaxPlayers,
                    math.floor(os.time() - workspace:GetServerTimeNow()),
                    game.Name,
                    game.PlaceId
                ),
                inline = false
            },
            {
                name = "üë• Online Players",
                value = #players > 0 and table.concat(playerList, "\n") or "*No players*",
                inline = true
            },
            {
                name = "üåê Server Info",
                value = string.format("Place ID: `%d`\nJob ID: `%s`\nRegion: `%s`",
                    game.PlaceId,
                    game.JobId,
                    game:GetService("LocalizationService").Region or "Unknown"
                ),
                inline = true
            }
        },
        thumbnail = {
            url = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=420&height=420&format=png",
                game.CreatorId
            )
        },
        footer = {
            text = "Auto-update setiap 30 menit"
        },
        timestamp = DateTime.now():ToIsoDate()
    }
    
    sendToDiscord(embed)
end

-- Jadwal periodic updates (setiap 30 menit)
while true do
    task.wait(1800)  -- 30 menit
    sendServerStatus()
end
